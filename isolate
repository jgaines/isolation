#!/bin/bash

# isolate - Run opencode in an isolated environment using bubblewrap
# Only allows access to this repository folder

set -euo pipefail
if [[ "${TRACE-0}" == "1" ]]; then
    set -o xtrace
fi

# Get the current working directory
REPO_DIR="$(pwd)"

# Check if bubblewrap is installed
if ! command -v bwrap &> /dev/null; then
    echo "Error: bubblewrap (bwrap) is not installed."
    echo "Install it with: sudo apt install bubblewrap (Ubuntu/Debian) or sudo dnf install bubblewrap (Fedora)"
    exit 1
fi

# Check if opencode is available and resolve its real path
if ! command -v opencode &> /dev/null; then
    echo "Error: opencode is not installed or not in PATH."
    echo "Make sure opencode is installed and accessible."
    exit 1
fi

# Get the real path to opencode binary (resolves symlinks)
OPENCODE_PATH="$(readlink -f "$(command -v opencode)")"

# We need to mount the directory containing the real opencode binary
# Get the parent directories we need to mount
OPENCODE_DIR="$(dirname "$OPENCODE_PATH")"

# OpenCode needs write access to its config/log directory
OPENCODE_CONFIG_DIR="$HOME/.local/share/opencode"

# Parse command line arguments for --rw, --ro, and --hide flags
EXTRA_MOUNTS=()
EXTRA_TMPFS=()
OPENCODE_ARGS=()
PARSING_RW=false
PARSING_RO=false
PARSING_HIDE=false

for arg in "$@"; do
    if [[ "$arg" == "--" ]]; then
        # End of mount options, everything after this goes to opencode
        PARSING_RW=false
        PARSING_RO=false
        PARSING_HIDE=false
    elif [[ "$arg" == "--rw" ]]; then
        PARSING_RW=true
        PARSING_RO=false
        PARSING_HIDE=false
    elif [[ "$arg" == "--ro" ]]; then
        PARSING_RO=true
        PARSING_RW=false
        PARSING_HIDE=false
    elif [[ "$arg" == "--hide" ]]; then
        PARSING_HIDE=true
        PARSING_RW=false
        PARSING_RO=false
    elif [[ ("$PARSING_RW" == true || "$PARSING_RO" == true || "$PARSING_HIDE" == true) && "$arg" != --* ]]; then
        # Resolve to absolute path and validate existence
        EXTRA_PATH="$(readlink -f "$arg")"
        if [[ -e "$EXTRA_PATH" ]]; then
            if [[ "$PARSING_RW" == true ]]; then
                EXTRA_MOUNTS+=("--bind" "$EXTRA_PATH" "$EXTRA_PATH")
                echo "Adding read-write mount: $EXTRA_PATH"
            elif [[ "$PARSING_RO" == true ]]; then
                EXTRA_MOUNTS+=("--ro-bind" "$EXTRA_PATH" "$EXTRA_PATH")
                echo "Adding read-only mount: $EXTRA_PATH"
            elif [[ "$PARSING_HIDE" == true ]]; then
                EXTRA_TMPFS+=("$EXTRA_PATH")
                echo "Adding hidden mount (tmpfs): $EXTRA_PATH"
            fi
        else
            echo "Warning: Extra path does not exist: $arg"
            exit 1
        fi
    else
        PARSING_RW=false
        PARSING_RO=false
        PARSING_HIDE=false
        if [[ "$arg" != "--rw" && "$arg" != "--ro" && "$arg" != "--hide" && "$arg" != "--" ]]; then
            OPENCODE_ARGS+=("$arg")
        fi
    fi
done

# Define standard read-only bind mounts
STANDARD_RO_BINDS=(
    "/usr"
    "/lib"
    "/lib64"
    "/bin"
    "/sbin"
    "/etc/passwd"
    "/etc/group"
    "/etc/nsswitch.conf"
    "/etc/resolv.conf"
    "/etc/ssl"
    "/etc/ca-certificates"
    "/usr/local/bin"
    "/home/linuxbrew/.linuxbrew"
    "$HOME"
)

# Define tmpfs directories
# There are two reasons for a directory to be in this list:
# - to provide a temp file system for example /tmp
# - to hide secrets with tmpfs overlay for example $HOME/.ssh
TMPFS_DIRS=(
    "/tmp"
    "/var/tmp"
    "/run"
    "$HOME/.aws"
    "$HOME/.gnupg"
    "$HOME/.ssh"
    "$HOME/tmp"
)

# Build the ro-bind arguments array
RO_BIND_ARGS=()
for path in "${STANDARD_RO_BINDS[@]}"; do
    RO_BIND_ARGS+=("--ro-bind" "$path" "$path")
done

# Build the tmpfs arguments array for hidden directories
TMPFS_ARGS=()
for path in "${TMPFS_DIRS[@]}"; do
    # Ensure the path is absolute and valid
    if [[ "$path" != /* ]]; then
        echo "Error: TMPFS directory path must be absolute: $path"
        exit 1
    elif [[ -d "$path" ]]; then
        TMPFS_ARGS+=("--tmpfs" "$path")
    fi
done

# Add extra tmpfs mounts from --hide option
for path in "${EXTRA_TMPFS[@]}"; do
    # Ensure the path is absolute (it should be since we resolved it earlier)
    if [[ "$path" != /* ]]; then
        echo "Error: TMPFS directory path must be absolute: $path"
        exit 1
    fi
    TMPFS_ARGS+=("--tmpfs" "$path")
done

echo "Starting isolated opencode session..."
echo "Repository: $REPO_DIR"
echo "Working directory inside sandbox: /workspace"
echo "OpenCode binary: $OPENCODE_PATH"
if [[ ${#EXTRA_MOUNTS[@]} -gt 0 ]]; then
    echo "Extra mounts: $((${#EXTRA_MOUNTS[@]} / 3))"
fi
echo ""

# Check if --help is being requested and show additional help
for arg in "${OPENCODE_ARGS[@]}"; do
    if [[ "$arg" == "--help" || "$arg" == "-h" ]]; then
        echo "isolate script - Additional options:"
        echo "  --ro PATH [PATH ...]   Add a read-only bind mount for PATH(s)"
        echo "  --rw PATH [PATH ...]   Add a read-write bind mount for PATH(s)"
        echo "  --hide PATH [PATH ...] Hide PATH(s) with tmpfs overlay"
        echo "  --                     End of mount options (optional)"
        echo ""
        echo "These options can be used multiple times to mount additional directories."
        echo "Paths will be resolved to absolute paths and validated before mounting."
        echo "Use '--' to explicitly separate mount options from opencode arguments."
        break
    fi
done

# Run opencode in bubblewrap sandbox
exec bwrap \
    "${RO_BIND_ARGS[@]}" \
    --bind "$OPENCODE_CONFIG_DIR" "$OPENCODE_CONFIG_DIR" \
    --bind "$REPO_DIR" /workspace \
    "${EXTRA_MOUNTS[@]}" \
    "${TMPFS_ARGS[@]}" \
    --proc /proc \
    --dev /dev \
    --unshare-all \
    --share-net \
    --new-session \
    --die-with-parent \
    --chdir /workspace \
    opencode "${OPENCODE_ARGS[@]}"